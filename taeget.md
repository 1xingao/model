# 三维地层建模与细化工作计划

## 总体目标
1. 基于 **克里金插值** 生成各地层连续表面，并在统一的公共采样点上建立总体三维模型。
2. 使用 **隐式建模思想** 对地层界面进行几何细化。
3. 基于 **KNN 属性赋值** 进行地层细节与属性的精确补充。

---

## 阶段 1 — 表面重建与公共采样

### 1. 数据准备
- **统一坐标系**：确保所有点数据（钻孔、剖面取点、CAD 边界）转换到相同投影坐标系。
- **数据清洗**：剔除异常高程、错误层位、重复点。
- **标注层位**：每个点需要明确所属层位（layer_id）。

### 2. 克里金插值构建层面
- 对每一地层单独处理：
  - 输入：该层所有采样点的 `(x, y, z)`。
  - 方法：普通克里金（Ordinary Kriging）或泛克里金（Universal Kriging）。
  - 输出：连续的层顶（或层底）表面。
- 工具建议：
  - Python: [`pykrige`](https://github.com/bsmurphy/PyKrige)
  - GIS: ArcGIS/Surfer/QGIS 插值工具

### 3. 公共采样点生成
- 定义研究区范围与 **XY 网格分辨率**（例如 5m × 5m）。
- 生成公共 `(x, y)` 网格。
- 在每个 `(x, y)` 上，通过插值表面提取对应层面的 Z 值。

---

## 阶段 2 — 隐式建模细化（几何一致性约束）

### 1. 思路
- 将每一地层界面表示为一个隐式函数 `f(x, y, z) = 0`。
- 输入训练数据：表面点（标签值 0）+ 上下方点（正/负距离值）。
- 隐式函数可用：
  - RBF（径向基函数）拟合
  - 有符号距离场（Signed Distance Field）
  - 神经隐式建模（MLP）

### 2. 操作步骤
1. **生成训练数据**：
   - 层面点：直接来自克里金生成的表面。
   - 上/下方样本：从表面上下方各偏移固定距离采样。
2. **拟合隐式函数**：
   - 方法 1：RBF 插值 → 得到连续的隐式场。
   - 方法 2：MLP → 学习 `(x, y, z)` → `f` 的映射。
3. **提取细化表面**：
   - 在三维网格中求解 `f(x, y, z) = 0` 等值面。
   - 替换原有的粗插值层面。

---

## 阶段 3 — KNN 属性赋值（细节补充）

### 1. 目标
- 在隐式建模生成的三维网格/体素上，为每个采样点赋予详细的地层属性（如沉积物类型、孔隙率、密度等）。

### 2. 步骤
1. 准备训练样本集：
   - `(x, y, z)` + 属性值（来自原始点数据或钻孔描述）。
2. 建立 KNN 模型：
   - 选择合适的 `k`（如 3~8）。
   - 距离度量可用欧氏距离或带权距离（Z 方向权重大）。
3. 对每个公共采样点：
   - 查找最近 k 个训练样本。
   - 用多数投票（分类属性）或加权平均（数值属性）赋值。

### 3. 工具建议
- Python: `scikit-learn` 的 `KNeighborsClassifier` / `KNeighborsRegressor`
- 对稀疏区域可与 IDW 插值混合使用。

---

## 阶段 4 — 验证与输出

### 1. 验证
- 剖面对比：在关键剖面上比较原始点、克里金表面、隐式细化表面。
- 交叉验证：随机剔除部分原始点，检验插值/细化结果误差。
- 属性验证：对比已知钻孔属性与 KNN 预测属性。

### 2. 输出
- 三维地层模型（如 VTK、GeoJSON、GOCAD、Leapfrog 格式）。
- 公共采样点数据表（`x, y, z_layer, 属性值`）。
- 分层等值面网格。

---

## 阶段 5 — 后续优化方向
- 引入地质结构约束（断层、侵蚀面）提升几何真实性。
- 结合地球物理反演结果更新隐式场。
- 自动化参数调优（如网格间距、k 值、克里金变程等）。
